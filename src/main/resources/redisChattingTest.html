<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Redis Pub/Sub ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { display: flex; gap: 20px; max-width: 1000px; margin: 0 auto; }
        .box {
            background: white; border-radius: 8px; padding: 20px; width: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-top: 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 95%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button {
            padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
            margin-right: 5px;
        }
        button.connect { background-color: #4CAF50; color: white; }
        button.send { background-color: #2196F3; color: white; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #log {
            height: 400px; overflow-y: auto; background: #333; color: #fff;
            padding: 15px; border-radius: 4px; font-family: monospace; font-size: 14px;
        }
        .log-msg { margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .log-sent { color: #81D4FA; } /* ë³´ë‚¸ ë©”ì‹œì§€ ìƒ‰ìƒ */
        .log-recv { color: #A5D6A7; } /* ë°›ì€ ë©”ì‹œì§€ ìƒ‰ìƒ */
    </style>
</head>
<body>

<div class="container">
    <div class="box">
        <h2>ğŸš€ ì—°ê²° ì„¤ì •</h2>
        <label>ì„œë²„ í¬íŠ¸ (8080 ë˜ëŠ” 8081):</label>
        <input type="number" id="port" value="8080" placeholder="í¬íŠ¸ ë²ˆí˜¸">
        <button class="connect" onclick="connect()">ì—°ê²°í•˜ê¸°</button>
        <button onclick="disconnect()" id="btnDisconnect" disabled>ì—°ê²° í•´ì œ</button>

        <hr style="margin: 20px 0;">

        <h2>ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡</h2>
        <label>ì±„íŒ…ë°© ID (RoomId):</label>
        <input type="number" id="roomId" value="1">

        <label>ë³´ë‚´ëŠ” ì‚¬ëŒ ID (SenderId):</label>
        <input type="number" id="senderId" value="100">

        <label>ë°›ëŠ” ì‚¬ëŒ ID (ReceiverId):</label>
        <input type="number" id="receiverId" value="200">

        <label>ë©”ì‹œì§€ ë‚´ìš©:</label>
        <input type="text" id="message" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
               onkeydown="if(event.isComposing) return; if(event.key==='Enter') sendMessage()">

        <button class="send" onclick="sendMessage()" id="btnSend" disabled>ì „ì†¡ (Send)</button>
    </div>

    <div class="box">
        <h2>ğŸ“œ ì‹¤ì‹œê°„ ë¡œê·¸</h2>
        <div id="log"></div>
    </div>
</div>

<script>
    let stompClient = null;

    function log(msg, type = '') {
        const logDiv = document.getElementById("log");
        const p = document.createElement("div");
        p.className = "log-msg " + type;

        // ì‹œê°„ ì¶”ê°€
        const time = new Date().toLocaleTimeString();
        p.textContent = `[${time}] ${msg}`;

        logDiv.appendChild(p);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function connect() {
        const port = document.getElementById('port').value;
        const roomId = document.getElementById('roomId').value;
        const receiverId = document.getElementById("senderId").value; // ë‚´ ì•„ì´ë””ë¡œ í êµ¬ë…

        // 1. ì—”ë“œí¬ì¸íŠ¸ ì£¼ì˜: /ws ë¡œ ì„¤ì •ë¨
        const socket = new WebSocket("ws://localhost:8080/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            log(`âœ… í¬íŠ¸ ${port} ì„œë²„ ì—°ê²° ì„±ê³µ!`);
            document.getElementById('btnDisconnect').disabled = false;
            document.getElementById('btnSend').disabled = false;

            // 2. ì±„íŒ…ë°© êµ¬ë…
            stompClient.subscribe(`/sub/chat/${roomId}`, function (msg) {
                const body = JSON.parse(msg.body);
                log(`ğŸ“¨ [ì±„íŒ…ìˆ˜ì‹ ] ${body.message}`, 'log-recv');
            });

            // 3. ë‚´ ì•Œë¦¼ í êµ¬ë… (ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹ ìš©)
            // /user/queue/updates ê²½ë¡œë¡œ ì˜¤ëŠ” ê°œì¸ ë©”ì‹œì§€ë¥¼ ë°›ìŠµë‹ˆë‹¤.
            stompClient.subscribe(`/user/queue/updates`, function (msg) {
                const body = JSON.parse(msg.body);
                log(`ğŸ”” [ëª©ë¡ê°±ì‹ ] ë°© ${body.roomId} ì—…ë°ì´íŠ¸ ì•Œë¦¼ ë„ì°©!`, 'log-recv');
            });

            log(`ğŸ“¡ êµ¬ë… ì™„ë£Œ: /sub/chat/${roomId} & /user/queue/updates`);

        }, function(error) {
            log(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error}`);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        document.getElementById('btnDisconnect').disabled = true;
        document.getElementById('btnSend').disabled = true;
        log("Disconnected");
    }

    function sendMessage() {
        const roomId = document.getElementById("roomId").value;
        const senderId = document.getElementById("senderId").value;
        const receiverId = document.getElementById("receiverId").value;
        const message = document.getElementById("message").value;

        if (!message) return;

        const payload = {
            roomId: parseInt(roomId),
            senderId: parseInt(senderId),
            receiverId: parseInt(receiverId),
            message: message
        };

        stompClient.send("/pub/send", {}, JSON.stringify(payload));
        log(`ğŸ“¤ [ì „ì†¡] ${message}`, 'log-sent');
        document.getElementById("message").value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
    }
</script>
</body>
</html>